<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link rel="icon" type="image/x-icon" href="img/favicon.svg">
    <title>لوحة مؤشرات الأداء - جمعية اعتدال</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-color: #40a187;
            --primary-light: #6cb499;
            --secondary-color: #2c3e50;
            --accent-color: #b3a28b;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: #f8faf9;
            color: #333;
        }

        .sidebar-gradient {
            background: linear-gradient(140deg, #6cb499 0%, #03866d 90%);
        }

        .sidebar-fixed {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-open {
            transform: translateX(0) !important;
        }

        @media (max-width: 768px) {
            .sidebar-fixed {
                position: fixed !important;
                z-index: 40 !important;
                top: 0;
                right: 0;
                bottom: 0;
                width: 85vw !important;
                min-width: 210px;
                max-width: 320px;
                height: 100vh !important;
                transform: translateX(100%);
                box-shadow: -6px 0 30px rgba(0, 0, 0, 0.2);
            }

            .overlay {
                display: block !important;
            }
        }

        @media (min-width: 769px) {
            .sidebar-fixed {
                position: sticky !important;
                top: 0;
                right: 0;
                height: 100vh !important;
                min-width: 260px;
                max-width: 280px;
            }

            .overlay {
                display: none !important;
            }
        }

        .active-nav {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            color: white !important;
            font-weight: bold;
            border-right: 4px solid var(--accent-color);
            backdrop-filter: blur(5px);
        }

        .shadow-card {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .fadein {
            animation: fadein 0.5s ease-out;
        }

        @keyframes fadein {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-btn i {
            min-width: 26px;
            text-align: center;
            transition: transform 0.2s;
        }

        .nav-btn:hover i {
            transform: scale(1.1);
        }

        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 6px;
        }

        .custom-scroll {
            scrollbar-width: thin;
            scrollbar-color: rgba(0, 0, 0, 0.1) transparent;
        }

        .btn-main {
            background: linear-gradient(92deg, var(--primary-light) 10%, var(--primary-color) 90%);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(108, 180, 153, 0.3);
            border-radius: 10px;
            padding: 0.7rem 1.4rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-size: 1rem;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-main:hover {
            background: linear-gradient(92deg, var(--primary-color), var(--primary-light));
            box-shadow: 0 6px 20px rgba(108, 180, 153, 0.4);
            transform: translateY(-2px);
        }

        .btn-main:active {
            transform: translateY(0);
        }

        .btn-main::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
            transform: translateY(-100%);
            transition: transform 0.3s;
        }

        .btn-main:hover::after {
            transform: translateY(0);
        }

        .logout-btn {
            background: linear-gradient(90deg, #ff4d4d 5%, #ff9999 95%);
            color: white;
            font-weight: bold;
            border-radius: 12px;
            padding: 0.6rem 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(255, 77, 77, 0.3);
            border: none;
            cursor: pointer;
        }

        .logout-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 77, 77, 0.4);
        }

        .input,
        select,
        textarea {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }

        .input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(108, 180, 153, 0.2);
            background-color: white;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-light);
        }

        .modal-bg {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 99;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadein 0.25s;
            padding-top: 2.8vh;
            padding-bottom: 2.8vh;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: white;
            border-radius: 16px;
            min-width: 340px;
            max-width: 600px;
            width: 99vw;
            padding: 2.5rem 1.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            direction: rtl;
            animation: fadein 0.25s;
            display: flex;
            flex-direction: column;
            margin: auto;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .modal-card label,
        .modal-card textarea,
        .modal-card input,
        .modal-card select {
            font-size: 1.04rem;
        }

        .modal-close-btn {
            position: absolute;
            top: 16px;
            left: 24px;
            background: #f9fafb;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            color: #777;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .modal-close-btn:hover {
            background: #ececec;
            transform: rotate(90deg);
            color: var(--primary-color);
        }

        @media (max-width:650px) {
            .modal-card {
                min-width: 97vw;
                max-width: 99vw;
                padding: 1.5rem 1rem;
            }
        }

        @media (max-width:500px) {
            .modal-card {
                min-width: 99vw;
                max-width: 99vw;
                padding: 1rem 0.5rem;
            }
        }

        .sidebar-logo {
            width: 240px;
            height: 100px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(108, 180, 153, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            transition: all 0.3s;
        }

        .sidebar-logo:hover {
            transform: scale(1.05);
        }

        .sidebar-brand-text {
            text-align: center;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-brand-desc {
            text-align: center;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 20px;
            font-weight: 300;
        }

        .badge-kind {
            display: inline-block;
            padding: 3px 10px;
            background: #f3f3f3;
            border-radius: 8px;
            color: var(--primary-color);
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .choices__inner {
            border-radius: 8px;
            min-height: 44px;
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
        }

        .choices[data-type*='select-multiple'] .choices__button {
            margin-right: 3px !important;
        }

        .choices[data-type*=select-multiple] .choices__button {
            border-left: none;
            margin: 0;
        }

        .choices__list--multiple .choices__item {
            direction: rtl;
            background: var(--primary-color);
            border: 1px solid var(--primary-light);
            color: white;
            border-radius: 6px;
        }

        .choices__list--dropdown,
        .choices__list[role="listbox"] {
            text-align: right;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .choices__item--selectable {
            padding-right: 1.3em;
        }

        .table-th {
            background: linear-gradient(to right, #eafbf5, #d8f7ec);
            color: var(--primary-color);
            font-weight: bold;
            text-align: right;
            padding: 12px;
        }

        .table-td {
            background: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 12px;
            transition: background 0.2s;
        }

        .table-td:hover {
            background: #f9f9f9;
        }

        .table {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-collapse: separate;
            border-spacing: 0;
        }

        /* أنماط جديدة للفترات الزمنية */
        .period-selector-container {
            margin-bottom: 1.5rem;
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
        }

        .period-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .period-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 14px;
            background: white;
            position: relative;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .period-card:hover {
            border-color: var(--primary-light);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .period-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .period-remove-btn {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .period-remove-btn:hover {
            transform: scale(1.2);
        }

        .target-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .type-selector {
            width: 100%;
        }

        .no-periods {
            text-align: center;
            color: #64748b;
            padding: 1.2rem;
            background: #f1f5f9;
            border-radius: 10px;
            border: 1px dashed #e0e0e0;
        }

        /* أنماط جديدة لجداول المتابعة */
        .goal-row {
            cursor: pointer;
            transition: all 0.2s;
        }

        .goal-row:hover {
            background-color: #f8fafc;
            transform: translateX(-5px);
        }

        .goal-details {
            background-color: #f8fafc;
            padding: 14px;
            border-radius: 10px;
            margin-top: 10px;
            border-left: 4px solid var(--primary-color);
            animation: fadein 0.3s;
        }

        .period-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .period-row:last-child {
            border-bottom: none;
        }

        .progress-bar {
            height: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-fill {
            height: 100%;
            transition: width 0.6s ease;
        }

        /* أنماط جديدة للمؤشرات الملونة */
        .progress-red {
            background: linear-gradient(to right, #ef4444, #f87171);
        }

        .progress-orange {
            background: linear-gradient(to right, #f97316, #fb923c);
        }

        .progress-yellow {
            background: linear-gradient(to right, #eab308, #facc15);
        }

        .progress-green {
            background: linear-gradient(to right, #22c55e, #4ade80);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .status-red {
            background: linear-gradient(to right, #fee2e2, #fecaca);
            color: #b91c1c;
        }

        .status-orange {
            background: linear-gradient(to right, #ffedd5, #fed7aa);
            color: #c2410c;
        }

        .status-yellow {
            background: linear-gradient(to right, #fef9c3, #fef08a);
            color: #a16207;
        }

        .status-green {
            background: linear-gradient(to right, #d1fae5, #a7f3d0);
            color: #065f46;
        }

        /* تحسينات جديدة للواجهة */
        .tracking-modal {
            max-width: 1000px !important;
            width: 95% !important;
        }

        .tracking-periods {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .tracking-period-item {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            /* Adjusted columns */
            gap: 14px;
            align-items: center;
            padding: 14px;
            transition: background 0.2s;
        }

        .tracking-period-item:hover {
            background: #fcfcfc;
        }

        .tracking-period-header {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1fr;
            /* Adjusted columns */
            gap: 14px;
            padding: 10px 14px;
            background: linear-gradient(to right, #eafbf5, #d8f7ec);
            font-weight: bold;
            border-radius: 10px 10px 0 0;
            color: var(--primary-color);
        }

        .weekly-details {
            max-height: 0;
            transition: max-height 0.5s ease-in-out;
            overflow: hidden;
        }

        @media (max-width: 768px) {

            .tracking-period-item,
            .tracking-period-header {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 10px;
            }

            .tracking-period-item>div:not(:last-child),
            .tracking-period-header>div:not(:last-child) {
                border-bottom: 1px dashed #f0f0f0;
                padding-bottom: 10px;
                margin-bottom: 10px;
            }
        }

        .achievement-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .achievement-input:focus {
            border-color: var(--primary-light);
            outline: none;
            box-shadow: 0 0 0 3px rgba(108, 180, 153, 0.2);
            background: white;
        }

        .achievement-type {
            font-size: 12px;
            color: #64748b;
            margin-top: 6px;
            text-align: center;
        }

        .save-achievement-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(3, 134, 109, 0.2);
        }

        .save-achievement-btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(3, 134, 109, 0.3);
        }

        .save-achievement-btn:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .period-year-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .period-quarter-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .reverse-indicator {
            display: inline-block;
            margin-right: 5px;
            transform: scaleX(-1);
            color: var(--accent-color);
        }

        /* Icon Picker Styles */
        .icon-picker-modal {
            max-width: 700px !important;
            padding: 1.5rem;
            z-index: 105;
            /* Make sure it appears above the main modal */
        }

        .icon-picker-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .icon-picker-search {
            width: 100%;
        }

        .icon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.75rem;
            max-height: 40vh;
            overflow-y: auto;
            padding: 0.5rem;
            border-top: 1px solid #eee;
        }

        .icon-picker-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.75rem;
            color: #555;
        }

        .icon-picker-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-light);
            transform: scale(1.1);
        }


        /* تأثيرات إضافية */
        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(108, 180, 153, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(108, 180, 153, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(108, 180, 153, 0);
            }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        /* تحسينات للرأس */
        header {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-bottom: none !important;
        }

        #mainTitle {
            color: var(--primary-color);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* تحسينات للبطاقات */
        .goal-card {
            position: relative;
            overflow: hidden;
        }

        .goal-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s;
        }

        .goal-card:hover::before {
            width: 8px;
        }

        /* تأثيرات النص */
        .text-gradient {
            background: linear-gradient(to right, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        /* تحسينات للشريط الجانبي */
        .user-profile {
            transition: all 0.3s;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* تحسينات للجداول */
        .table-container {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            background: white;
        }

        /* تأثيرات التحميل */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-spinner {
            border: 4px solid rgba(108, 180, 153, 0.2);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        /* تأثيرات النوافذ المنبثقة */
        .modal-enter {
            opacity: 0;
            transform: scale(0.9);
        }

        .modal-enter-active {
            opacity: 1;
            transform: scale(1);
            transition: all 0.3s;
        }

        .modal-exit {
            opacity: 1;
        }

        .modal-exit-active {
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.3s;
        }

        /* تحسينات للأيقونات */
        .icon-btn {
            transition: all 0.2s;
        }

        .icon-btn:hover {
            transform: scale(1.1);
            color: var(--primary-color);
        }

        /* تأثيرات للتنبيهات */
        .toast {
            animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }
    </style>
</head>

<body class="relative min-h-screen">
    <div class="flex min-h-screen">
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-30 hidden overlay" style="cursor:pointer" onclick="closeSidebar()"></div>
        <aside id="sidebar" class="sidebar-fixed sidebar-gradient flex flex-col transition-transform duration-300 h-screen z-40" style="width:260px;">
            <div class="p-6 pb-0 flex flex-col items-center">
                <div class="sidebar-logo floating"><img src="img/logoW.png" alt="شعار"></div>
                <div class="sidebar-brand-text">منصة إدارة الأداء</div>
                <div class="sidebar-brand-desc">لوحة التحكم الإدارية</div>
            </div>
            <nav class="flex-1 mt-4 flex flex-col gap-2 px-2">
                <button class="nav-btn active-nav flex items-center gap-3 p-3 text-white hover:bg-white/10 rounded-lg transition text-base" data-section="section-strategic">
                    <i class="fa fa-bullseye"></i> الأهداف الاستراتيجية
                </button>
                <button class="nav-btn flex items-center gap-3 p-3 text-white hover:bg-white/10 rounded-lg transition text-base" data-section="section-operational">
                    <i class="fa fa-tasks"></i> الأهداف التشغيلية
                </button>
                <button class="nav-btn flex items-center gap-3 p-3 text-white hover:bg-white/10 rounded-lg transition text-base" data-section="section-tracking">
                    <i class="fa fa-chart-line"></i> متابعة الإنجاز
                </button>
                <button class="nav-btn flex items-center gap-3 p-3 text-white hover:bg-white/10 rounded-lg transition text-base" data-section="section-dept">
                    <i class="fa fa-sitemap"></i> الإدارات
                </button>
                <button class="nav-btn flex items-center gap-3 p-3 text-white hover:bg-white/10 rounded-lg transition text-base" data-section="section-users">
                    <i class="fa fa-users"></i> المستخدمون
                </button>

                <button class="nav-btn flex items-center gap-3 p-3 text-white hover:bg-white/10 rounded-lg transition text-base" data-section="section-settings">
                    <i class="fa fa-cog"></i> الإعدادات
                </button>

            </nav>

            <div class="mt-auto p-4 border-t border-white/10 user-profile">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#6cb499] to-[#03866d] text-white flex items-center justify-center text-lg font-bold shadow">
                        <i class="fa fa-user"></i>
                    </div>
                    <div>
                        <div id="userName" class="font-bold text-white text-sm">...</div>
                        <div id="userEmail" class="text-xs text-white/80 truncate max-w-[120px]">...</div>
                    </div>
                </div>
            </div>

        </aside>


        <main class="flex-1 flex flex-col min-h-screen relative transition-colors duration-200 bg-[#f8faf9]">

            <header class="flex items-center justify-between px-6 py-4 bg-white sticky top-0 z-10 shadow-card">
                <button class="md:hidden text-[#6cb499] text-2xl p-2 hover:bg-gray-100 rounded-full" onclick="openSidebar()">
                    <i class="fa fa-bars"></i>
                </button>
                <div>
                    <div id="mainTitle" class="text-xl md:text-2xl font-bold text-[#03866d]">منصة إدارة الأداء</div>
                    <div id="mainSubtitle" class="text-xs md:text-sm text-gray-500">إدارة وتتبع الأهداف الاستراتيجية والتشغيلية
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="logoutBtn" class="logout-btn pulse">
                        <i class="fa fa-sign-out-alt"></i>خروج
                    </button>
                    <img src="https://api.dicebear.com/8.x/initials/svg?seed=م.ع" alt="user" class="w-10 h-10 rounded-full border-2 border-[#6cb499] shadow hover:border-[#03866d] transition" />
                </div>
            </header>

            <section class="flex-1 px-4 md:px-8 py-6 md:py-8 grid grid-cols-1 md:grid-cols-3 gap-6 custom-scroll overflow-auto">

                <div id="section-strategic" class="section-tab col-span-3">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-bold text-2xl text-[#03866d]">الأهداف الاستراتيجية</h2>
                        <button class="btn-main" id="addStrategicBtn" onclick="openModal('strategic')"><i class="fa fa-plus"></i>
                            إضافة هدف</button>
                    </div>
                    <div id="strategicGoalsList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </div>

                <div id="section-operational" class="section-tab col-span-3 hidden">

                    <div class="flex flex-col md:flex-row gap-3 mb-5">
                        <input id="opGoalsSearchInput" type="text" class="input w-full md:w-1/3" placeholder="بحث بالاسم..." oninput="filterOperationalGoals()">
                        <select id="opGoalsDeptFilter" class="input w-full md:w-1/4" onchange="filterOperationalGoals()">
                            <option value="">كل الإدارات</option>
                        </select>
                    </div>


                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-bold text-2xl text-[#03866d]">الأهداف التشغيلية</h2>

                        <button class="btn-main" id="addOperationalBtn" onclick="openModal('operational')"><i class="fa fa-plus"></i> إضافة هدف</button>
                    </div>
                    <div id="operationalGoalsList" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </div>

                <div id="section-tracking" class="section-tab col-span-3 bg-white rounded-xl shadow-card p-6 overflow-auto hidden">
                    <div class="table-container">
<div class="flex flex-col md:flex-row gap-3 mb-5 flex-wrap">
    <input id="trackingSearchInput" type="text" class="input w-full md:w-1/4" placeholder="بحث بالاسم..." oninput="filterTrackingTable()">
    
    <select id="trackingDeptFilter" class="input w-full md:w-1/5" onchange="filterTrackingTable()">
        <option value="">كل الإدارات</option>
    </select>
    
    <select id="trackingQuarterFilter" class="input w-full md:w-1/5" onchange="updateTrackingWeekOptions(); filterTrackingTable()">
        <option value="">كل الأرباع</option>
        <option value="Q1">الربع الأول</option>
        <option value="Q2">الربع الثاني</option>
        <option value="Q3">الربع الثالث</option>
        <option value="Q4">الربع الرابع</option>
    </select>

    <select id="trackingMethodFilter" class="input w-full md:w-1/5" onchange="updateTrackingWeekOptions(); filterTrackingTable()">
        <option value="">كل طرق المتابعة</option>
        <option value="weekly">تجميع أسبوعي</option>
        <option value="direct">إدخال مباشر</option>
    </select>

    <select id="trackingWeekFilter" class="input w-full md:w-1/6 hidden" onchange="filterTrackingTable()">
        <option value="">كل الأسابيع</option>
    </select>
</div>
                        <table class="min-w-full text-sm">
                            <thead>
                                <tr class="bg-[#eafbf5] text-[#03866d]">
                                    <th class="p-4 text-right">#</th>
                                    <th class="p-4 text-right">الهدف الاستراتيجي</th>
                                    <th class="p-4 text-right">الهدف التشغيلي</th>
                                    <th class="p-4 text-right">المؤشر</th>
                                    <th class="p-4 text-right">الإدارة</th>
                                    <th class="p-4 text-right">النسبة</th>
                                    <th class="p-4 text-right">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="trackingTable"></tbody>
                        </table>
                    </div>
                </div>

                <div id="section-dept" class="section-tab col-span-3 bg-white rounded-xl shadow-card p-6 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-bold text-2xl text-[#03866d]">الإدارات</h2>
                        <button class="btn-main" id="addDeptBtn" onclick="openModal('department')"><i class="fa fa-plus"></i> إضافة
                            إدارة</button>
                    </div>
                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full table">
                            <thead class="text-right">
                                <tr>
                                    <th class="table-th p-4">اسم الإدارة</th>
                                    <th class="table-th p-4">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="departmentsList"></tbody>
                        </table>
                    </div>
                </div>

                <div id="section-users" class="section-tab col-span-3 bg-white rounded-xl shadow-card p-6 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-bold text-2xl text-[#03866d]">المستخدمون</h2>
                        <button class="btn-main" id="addUserBtn" onclick="openModal('user')"><i class="fa fa-user-plus"></i> إضافة
                            مستخدم</button>
                    </div>
                    <div class="overflow-x-auto table-container">
                        <table class="min-w-full table">
                            <thead class="text-right">
                                <tr>
                                    <th class="table-th p-4">الاسم</th>
                                    <th class="table-th p-4">الإدارات</th>
                                    <th class="table-th p-4">البريد الإلكتروني</th>
                                    <th class="table-th p-4">الصلاحية</th>
                                    <th class="table-th p-4">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="usersList"></tbody>
                        </table>
                    </div>
                </div>


                <div id="section-settings" class="section-tab col-span-3 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="font-bold text-2xl text-[#03866d]">الإعدادات</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="card">
                            <h3 class="font-bold text-lg mb-4 text-[#03866d] flex items-center gap-2">
                                <i class="fas fa-desktop"></i> إعدادات العرض
                            </h3>
                            <div class="flex items-center gap-4 mb-4">
                                <input type="checkbox" id="showUnweightedCheckbox" onchange="updateSetting('showUnweighted', this.checked)">
                                <label for="showUnweightedCheckbox" class="text-sm font-bold text-gray-600">
                                    إظهار الأهداف غير الموزونة في لوحة المعلومات
                                </label>
                            </div>
                            <div class="flex justify-end mt-6">
                                <button id="saveSettingsBtn" onclick="saveSettings()" class="btn-main">
                                    <i class="fas fa-save mr-2"></i>
                                    حفظ الإعدادات
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-bold text-lg text-[#03866d] flex items-center gap-2">
                                    <i class="fas fa-calculator"></i> أنواع قيم الإنجاز
                                </h3>
                                <button class="btn-main !py-2 !px-4 !text-sm" id="addAchievementValueTypeBtn" onclick="openModal('achievementValueType')">
                                    <i class="fa fa-plus"></i> إضافة نوع
                                </button>
                            </div>
                            <div class="overflow-x-auto table-container">
                                <table class="min-w-full table">
                                    <thead class="text-right">
                                        <tr>
                                            <th class="table-th p-4">اسم النوع</th>
                                            <th class="table-th p-4">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="achievementValueTypesList">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </section>
        </main>
    </div>
    <div id="toast" class="fixed top-6 right-6 z-50 bg-white shadow-lg px-6 py-3 rounded-lg text-sm hidden transition-all duration-300 transform">
    </div>
    <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex flex-col items-center justify-center z-[200] hidden backdrop-filter backdrop-blur-sm">
        <div class="loading-spinner mb-6"></div>
        <div id="loadingText" class="text-white text-lg font-bold"></div>
    </div>
    <div id="modals-root"></div>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>



    <script>
const firebaseConfig = {
  apiKey: "AIzaSyCpGFGcxtoOt_XogdT-pS1dgxObBegqjS8",
  authDomain: "e3tdal-32d54.firebaseapp.com",
  projectId: "e3tdal-32d54",
  storageBucket: "e3tdal-32d54.firebasestorage.app",
  messagingSenderId: "217166225784",
  appId: "1:217166225784:web:76e876779139f94438a88d",
  measurementId: "G-YFDH35V8W5"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
    if (!userProfile || !userProfile.email) window.location.href = "login.html";
    
    let allIcons = null;
    let iconsLoadingPromise = null;
    
    function loadAllIcons() {
        if (allIcons) return Promise.resolve(); 
        if (iconsLoadingPromise) return iconsLoadingPromise; 

        iconsLoadingPromise = (async () => {
            try {
                // Correct, reliable URL for the metadata file
                const response = await fetch('https://raw.githubusercontent.com/FortAwesome/Font-Awesome/6.4.0/metadata/icons.json');
                if (!response.ok) throw new Error('Network response was not ok');
                allIcons = await response.json();
                console.log("Font Awesome icons loaded successfully.");
            } catch (error) {
                console.error("Failed to load Font Awesome icons:", error);
                window.showToast("فشل تحميل مكتبة الأيقونات", "error");
                // Minimal fallback list
                allIcons = { 'tasks': { styles: ['solid'], free:['solid'], search: { terms: [] } }, 'bullseye': { styles: ['solid'], free:['solid'], search: { terms: [] } } }; 
            }
        })();
        return iconsLoadingPromise;
    }
    
    // Make these functions globally accessible
    window.openIconPicker = async function() {
        const pickerRoot = document.createElement('div');
        pickerRoot.id = 'iconPickerModal';
        pickerRoot.className = 'modal-bg';
        pickerRoot.style.zIndex = '101';
        pickerRoot.onclick = (e) => { if(e.target === pickerRoot) pickerRoot.remove(); };
        
        pickerRoot.innerHTML = `
            <div class="modal-card icon-picker-modal">
                <button class="modal-close-btn" onclick="document.getElementById('iconPickerModal').remove()" type="button"><i class="fa fa-times"></i></button>
                <h3 class="font-bold text-xl mb-4 text-[#03866d]">اختر أيقونة</h3>
                <div class="icon-picker-header">
                    <input type="text" id="iconSearchInput" class="input icon-picker-search" placeholder="ابحث عن أيقونة (مثال: مال، سهم، chart)..." oninput="window.filterIcons()">
                </div>
                <div id="icon-picker-grid" class="icon-picker-grid custom-scroll">
                    <div class="loading-spinner mx-auto mt-8"></div>
                </div>
            </div>
        `;
        document.body.appendChild(pickerRoot);
        document.getElementById('iconSearchInput').focus();

        await loadAllIcons(); // Ensure icons are loaded before proceeding
        
        if (!allIcons) {
            document.getElementById('icon-picker-grid').innerHTML = '<p class="text-center text-red-500">فشل تحميل الأيقونات.</p>';
            return;
        }

        const grid = document.getElementById('icon-picker-grid');
        let iconsHtml = '';
        for (const iconName in allIcons) {
            if (allIcons[iconName].styles && allIcons[iconName].styles.includes('solid') && allIcons[iconName].free.includes('solid')) {
                const keywords = allIcons[iconName].search.terms.join(' ');
                iconsHtml += `<button type="button" class="icon-picker-btn" data-icon-class="fa-${iconName}" data-keywords="${keywords} ${iconName}" onclick="window.selectIcon('fa-${iconName}')"><i class="fa-solid fa-${iconName}"></i></button>`;
            }
        }
        grid.innerHTML = iconsHtml;
    }

    window.filterIcons = function() {
        const searchTerm = document.getElementById('iconSearchInput').value.toLowerCase();
        const iconButtons = document.querySelectorAll('.icon-picker-btn');

        iconButtons.forEach(btn => {
            const keywords = btn.dataset.keywords.toLowerCase();
            btn.style.display = keywords.includes(searchTerm) ? 'flex' : 'none';
        });
    }

    window.selectIcon = function(iconClass) {
        document.getElementById('goalIconInput').value = iconClass;
        document.querySelector('#iconSelectBtn i').className = `fa-solid ${iconClass} text-2xl text-slate-700`;
        document.getElementById('iconPickerModal').remove();
    }


    firebase.firestore().collection("users").where("email", "==", userProfile.email).limit(1).get().then(snapshot => {
        if (!snapshot.empty) {
            const userData = snapshot.docs[0].data();
            userData.id = snapshot.docs[0].id;
            localStorage.setItem('userProfile', JSON.stringify(userData));
            if (userData.role !== userProfile.role || JSON.stringify(userData.departmentIds) !== JSON.stringify(userProfile.departmentIds)) {
                window.location.reload();
            } else {
                startDashboard(userData);
            }
        } else {
            // localStorage.clear(); sessionStorage.clear();
            // window.location.href = "login.html";
        }
    });

    function startDashboard(userProfile) {
        document.getElementById('userName').textContent = userProfile.name || userProfile.email || '';
        document.getElementById('userEmail').textContent = userProfile.email || '';
        const isManager = userProfile.role === 'manager' || userProfile.role === 'مدير';
        
        loadAllIcons(); // Start fetching icons in the background

        document.getElementById('logoutBtn').onclick = function () {
            localStorage.clear(); sessionStorage.clear();
            firebase.auth().signOut().then(function () {
                window.location.href = "login.html";
            }).catch(function () {
                showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
                window.location.href = "login.html";
            });
        };

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.onclick = function () {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav'));
                btn.classList.add('active-nav');
                document.querySelectorAll('.section-tab').forEach(s => s.classList.add('hidden'));
                document.getElementById(btn.dataset.section).classList.remove('hidden');
                closeSidebar();
            }
        });

        window.showToast = function (msg, type = "success") {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = "fixed top-6 right-6 z-50 px-6 py-3 rounded-lg text-sm " +
                (type == "success" ? "bg-[#eafbf5] text-[#03866d] border border-[#6cb499]" :
                    type == "error" ? "bg-red-50 text-red-900 border border-red-200" :
                        "bg-yellow-50 text-yellow-900 border border-yellow-200");
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        };

        window.openSidebar = function () {
            document.getElementById('sidebar').classList.add('sidebar-open');
            document.getElementById('sidebarOverlay').classList.remove('hidden');
            document.body.style.overflow = "hidden";
        };
        window.closeSidebar = function () {
            document.getElementById('sidebar').classList.remove('sidebar-open');
            document.getElementById('sidebarOverlay').classList.add('hidden');
            document.body.style.overflow = "";
        };

        let departments = [], departmentsMap = {}, strategicGoals = [], operationalGoals = [], users = [], achievementValueTypes = [];
        let achievementValueTypesMap = {};
        let appSettings = { showUnweighted: false };

        db.collection('settings').doc('appSettings').get().then(doc => {
            if (doc.exists) {
                appSettings = doc.data();
                if (document.getElementById('showUnweightedCheckbox')) {
                    document.getElementById('showUnweightedCheckbox').checked = appSettings.showUnweighted || false;
                }
            }
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.style.display = isManager ? '' : 'none';
            }
        }).catch(error => {
            console.error("Error loading settings:", error);
        });

        window.updateSetting = function (key, value) {
            appSettings[key] = value;
        };


        window.saveSettings = function () {
            if (!isManager) {
                showToast('ليس لديك صلاحية لتعديل الإعدادات', 'error');
                return;
            }
            showLoading('جاري حفظ الإعدادات...');
            db.collection('settings').doc('appSettings').set(appSettings)
                .then(() => {
                    hideLoading();
                    showToast('تم حفظ الإعدادات بنجاح');
                })
                .catch(error => {
                    hideLoading();
                    showToast('حدث خطأ أثناء حفظ الإعدادات', 'error');
                    console.error('Error saving settings:', error);
                });
        };

        // Initialize all data listeners
        refreshDepartments();
        refreshStrategicGoals();
        refreshOperationalGoals();
        refreshUsers();
        refreshAchievementValueTypes(); 

        function applyPermissions() {
            document.getElementById('addStrategicBtn').style.display = isManager ? '' : 'none';
            document.getElementById('addOperationalBtn').style.display = isManager ? '' : 'none';
            document.getElementById('addDeptBtn').style.display = isManager ? '' : 'none';
            document.getElementById('addUserBtn').style.display = isManager ? '' : 'none';
            document.getElementById('addAchievementValueTypeBtn').style.display = isManager ? '' : 'none';

            document.querySelectorAll('.edit-btn, .delete-btn, .edit-dept-btn, .delete-dept-btn, .edit-user-btn, .delete-user-btn, .edit-achievement-value-type-btn, .delete-achievement-value-type-btn').forEach(btn => {
                btn.style.display = isManager ? '' : 'none'
            });

            document.querySelectorAll('.edit-achieve-btn').forEach(btn => {
                const goalDeptId = btn.getAttribute('data-department');
                const userDepts = userProfile.departmentIds || (userProfile.departmentId ? [userProfile.departmentId] : []);
                btn.style.display = (isManager || userDepts.includes(goalDeptId)) ? '' : 'none';
            });
            
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            if (saveSettingsBtn) {
                saveSettingsBtn.style.display = isManager ? '' : 'none';
            }
        }

        function refreshDepartments() {
            db.collection('departments').orderBy('name').onSnapshot(snap => {
                departments = [];
                departmentsMap = {};
                snap.forEach(d => {
                    departments.push({ id: d.id, ...d.data() });
                    departmentsMap[d.id] = d.data().name;
                });
                renderDepartments();
                updateOpGoalsDeptFilter();
                updateTrackingDeptFilter();
                renderUsers();
            });
        }

        function renderDepartments() {
            let list = document.getElementById('departmentsList');
            list.innerHTML = "";
            if (!departments.length) {
                list.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 p-6">لا توجد إدارات</td></tr>`;
                return;
            }
            departments.forEach(dept => {
                list.innerHTML += `
                    <tr>
                        <td class="table-td p-4 font-bold">${dept.name}</td>
                        <td class="table-td p-4">
                            <button class="edit-dept-btn text-blue-500 hover:text-blue-700 icon-btn" title="تعديل" 
                                onclick="openModal('department-edit','${dept.id}')">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="delete-dept-btn text-red-500 hover:text-red-700 icon-btn ml-2" title="حذف" 
                                onclick="deleteDept('${dept.id}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            applyPermissions();
        }

        window.deleteDept = async function (id) {
            if (!isManager) return;
            
            // FIX: Check if department is used before deleting
            const opGoalsSnapshot = await db.collection('operationalGoals').where('departmentId', '==', id).limit(1).get();
            if (!opGoalsSnapshot.empty) {
                showToast("لا يمكن حذف الإدارة لأنها مرتبطة بأهداف تشغيلية", "error");
                return;
            }

            const usersSnapshot = await db.collection('users').where('departmentIds', 'array-contains', id).limit(1).get();
            if (!usersSnapshot.empty) {
                showToast("لا يمكن حذف الإدارة لأنها مرتبطة بمستخدمين", "error");
                return;
            }
            
            if (confirm("هل أنت متأكد من حذف الإدارة؟")) {
                db.collection('departments').doc(id).delete().then(() => {
                    showToast("تم حذف الإدارة بنجاح");
                }).catch(err => {
                    showToast("حدث خطأ أثناء الحذف", "error");
                    console.error("Error deleting department:", err);
                });
            }
        }

        function refreshStrategicGoals() {
            db.collection('strategicGoals').orderBy('goal', 'asc').onSnapshot(snap => {
                strategicGoals = [];
                snap.forEach(d => strategicGoals.push({ id: d.id, ...d.data() }));
                renderStrategicGoals();
            });
        }

        function renderStrategicGoals() {
            let list = document.getElementById('strategicGoalsList');
            list.innerHTML = "";
            if (!strategicGoals.length) {
                list.innerHTML = `<div class="text-gray-400 col-span-3 p-12 text-center">لا توجد أهداف استراتيجية بعد</div>`;
                return;
            }
            strategicGoals.forEach(goal => {
                let yearsDisp = Array.isArray(goal.years) ? goal.years.join('، ') : '';
                let card = document.createElement('div');
                card.className = "card fadein flex flex-col gap-4 goal-card";
                card.innerHTML = `
                    <div class="flex items-center gap-2 text-xs mb-1">
                        <span class="bg-[#eafbf5] text-[#03866d] rounded-full px-3 py-1 font-bold">${yearsDisp}</span>
                        <span class="ml-auto text-slate-400">#${goal.id.substr(0, 5)}</span>
                    </div>
                    <div class="text-lg font-bold text-[#2e3d34] leading-relaxed">${goal.goal}</div>
                    <div class="flex justify-end gap-2 mt-auto">
                        <button class="edit-btn text-blue-500 hover:text-blue-700 icon-btn" title="تعديل" 
                            onclick="openModal('strategic', '${goal.id}')">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="delete-btn text-red-500 hover:text-red-700 icon-btn ml-2" title="حذف" 
                            onclick="deleteStrategicGoal('${goal.id}')">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(card);
            });
            applyPermissions();
        }

        window.deleteStrategicGoal = async function (id) {
            if (!isManager) return;
            let snapshot = await db.collection('operationalGoals').where('strategicGoalId', '==', id).get();
            if (!snapshot.empty) {
                showToast("لا يمكن حذف الهدف لأنه مرتبط بأهداف تشغيلية", "error");
                return;
            }
            if (confirm("هل أنت متأكد من حذف الهدف الاستراتيجي؟")) {
                db.collection('strategicGoals').doc(id).delete();
            }
        }

        function refreshOperationalGoals() {
            db.collection('operationalGoals').orderBy('goal', 'asc').onSnapshot(snap => {
                operationalGoals = [];
                snap.forEach(d => {
                    operationalGoals.push({ id: d.id, ...d.data() });
                });
                renderOperationalGoals();
                renderTrackingGoals();
                renderTotalAchievementBar();
            });
        }

        function getProgressColor(percent, isReverse = false) {
            if (isReverse) percent = 100 - percent;
            if (percent < 50) return 'red';
            if (percent >= 50 && percent <= 60) return 'orange';
            if (percent > 60 && percent <= 79) return 'yellow';
            return 'green';
        }

        function getStatusColor(percent, isReverse = false) {
            if (isReverse) percent = 100 - percent;
            if (percent < 50) return 'status-red';
            if (percent >= 50 && percent <= 60) return 'status-orange';
            if (percent > 60 && percent <= 79) return 'status-yellow';
            return 'status-green';
        }

        function renderTotalAchievementBar() {
            let totalPercent = 0, totalWeight = 0;
            operationalGoals
                .filter(goal => !goal.excludeFromCalculation)
                .forEach(goal => {
                    let count = 0, sum = 0;
                    if (goal.progress && goal.progress.length) {
                        goal.progress.forEach(period => {
                            sum += calculateAchievementPercent(period, goal.isReverse);
                            count++;
                        });
                    }
                    let avgPercent = count > 0 ? sum / count : 0;
                    totalPercent += avgPercent * (Number(goal.weight) || 0);
                    totalWeight += Number(goal.weight) || 0;
                });
            let avg = totalWeight > 0 ? (totalPercent / totalWeight) : 0;
            if (document.getElementById('totalAchievementPercent'))
                document.getElementById('totalAchievementPercent').textContent = avg.toFixed(1) + "%";
            if (document.getElementById('totalAchievementBar'))
                document.getElementById('totalAchievementBar').style.width = avg.toFixed(1) + "%";
        }

        function renderOperationalGoals() {
            let list = document.getElementById('operationalGoalsList');

            list.innerHTML = "";
            if (!operationalGoals.length) {
                list.innerHTML = `<div class="text-gray-400 col-span-3 p-12 text-center">لا توجد أهداف تشغيلية بعد</div>`;
                return;
            }

            operationalGoals
                .filter(goal => {
                    let matchSearch = true;
                    if (opGoalsFilter.search) {
                        let searchIn = (goal.goal || '') + ' ' + (goal.strategicGoalText || '') + ' ' + (goal.indicator || '') + ' ' + (departmentsMap[goal.departmentId] || '');
                        matchSearch = searchIn.toLowerCase().includes(opGoalsFilter.search);
                    }
                    let matchDept = !opGoalsFilter.departmentId || goal.departmentId == opGoalsFilter.departmentId;
                    return matchSearch && matchDept;
                }).forEach(goal => {
                    let totalPercent = 0, count = 0;
                    let periodsSummary = "";
                    let periodArr = [];
                    if (goal.progress && goal.progress.length) {
                        goal.progress
                            .sort((a, b) => (a.year + a.quarter).localeCompare(b.year + b.quarter))
                            .forEach(period => {
                                let percent = calculateAchievementPercent(period, goal.isReverse);
                                totalPercent += percent;
                                count++;
                                let qStr = `Q${period.quarter.replace("Q", "")}`;
                                periodArr.push({
                                    year: period.year,
                                    quarter: qStr,
                                    percent: percent,
                                    color: getProgressColor(percent, goal.isReverse)
                                });
                            });
                        periodsSummary = periodArr.map(p =>
                            `<span class="inline-flex items-center gap-1 mb-1 px-2 py-1 rounded-full text-xs font-medium bg-white border border-slate-200 shadow-sm"
                                 style="color: var(--${p.color}-700); background: var(--${p.color}-100)">
                                 <span class="font-bold">${p.year}-${p.quarter}</span>
                                 <span class="ml-1 text-[10px] opacity-80">${Math.round(p.percent)}%</span>
                             </span>`
                        ).join(' ');
                    }
                    
                    let displayBadgesHtml = '';
                    const options = goal.displayOptions || [];
                    if (options.includes('general')) {
                        displayBadgesHtml += `<span class="inline-flex items-center gap-1.5 rounded-full px-2 py-1 text-xs font-medium text-blue-700 bg-blue-100"><i class="fa-solid fa-gauge-high"></i> الشاشة العامة</span>`;
                    }
                    if (options.includes('operational')) {
                        displayBadgesHtml += `<span class="inline-flex items-center gap-1.5 rounded-full px-2 py-1 text-xs font-medium text-green-700 bg-green-100"><i class="fa-solid fa-list-check"></i> الأداء التشغيلي</span>`;
                    }
                    if(options.length === 0){
                        displayBadgesHtml = `<span class="inline-flex items-center gap-1.5 rounded-full px-2 py-1 text-xs font-medium text-gray-600 bg-gray-100"><i class="fa-solid fa-eye-slash"></i> مخفي</span>`;
                    }


                    let avgPercent = count > 0 ? totalPercent / count : 0;
                    const progressColor = getProgressColor(avgPercent, goal.isReverse);
                    const statusColor = getStatusColor(avgPercent, goal.isReverse);
                    const reverseText = goal.isReverse ? `<span class="reverse-indicator">↪️</span>` : "";
                    let deptName = goal.departmentId ? (departmentsMap[goal.departmentId] || '') : '';
                    let indicator = goal.indicator || "";
                    let weight = goal.weight || "";
                    let strategicGoalText = goal.strategicGoalText || "";
                    let weightText = (goal.excludeFromCalculation ? 'بدون وزن' : weight);
                    let card = document.createElement('div');
                    card.className = "card fadein flex flex-col gap-2";

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-1">
                            <span class="text-xs font-bold text-[#03866d] bg-[#eafbf5] px-3 py-1 rounded-full">${deptName || '&nbsp;'}</span>
                            ${reverseText}
                        </div>
                        <div class="flex items-start gap-3">
                            <i class="fa-solid ${goal.icon || 'fa-tasks'} text-2xl text-slate-400 mt-1"></i>
                            <div class="flex-1">
                                <div class="font-bold text-base md:text-lg text-[#2e3d34] leading-relaxed">${goal.goal}</div>
                                <div class="text-sm text-gray-500">${strategicGoalText}</div>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 my-2 items-center">
                           ${displayBadgesHtml}
                        </div>

                        <div class="flex flex-wrap gap-2 items-center">
                            <span class="inline-flex items-center rounded-xl px-3 py-1 bg-indigo-50 text-indigo-900 text-xs font-semibold border border-indigo-100 relative">
                                <i class="fa fa-chart-bar mr-1"></i> ${indicator}
                                ${goal.calculationMethod && goal.calculationMethod.trim()
                                    ? `
                                <button class="ml-1 calculation-method-btn flex items-center justify-center rounded-full bg-white border border-indigo-200 w-6 h-6 shadow transition hover:bg-indigo-100"
                                    title="طريقة حساب المؤشر" onclick="showCalculationMethod('${goal.id}', event)">
                                    <i class="fa fa-info-circle text-indigo-600 text-base"></i>
                                </button>
                                `
                                    : ''
                                }
                            </span>
                            <span class="inline-block rounded-xl px-3 py-1 bg-pink-50 text-pink-800 text-xs font-semibold border border-pink-100">
                                الوزن: ${weightText}
                            </span>
                        </div>
                        
                        <div class="flex flex-wrap gap-1 my-2 items-center min-h-[26px]">
                            ${periodsSummary}
                        </div>
                        
                        <div class="flex items-center gap-3 mt-auto">
                            <div class="flex-1 h-2 rounded-xl bg-slate-200 overflow-hidden shadow-inner">
                                <div class="h-2 rounded-xl progress-${progressColor} transition-all duration-500"
                                    style="width:${Math.min(avgPercent, 100)}%"></div>
                            </div>
                            <span class="text-xs ${statusColor} rounded-xl px-3 py-1 font-bold tracking-tight shadow border border-slate-100 bg-white">
                                ${avgPercent.toFixed(1)}%
                            </span>
                        </div>
                        
                        <div class="flex justify-end gap-2 mt-2">
                            <button class="edit-btn text-blue-500 hover:text-blue-700 icon-btn" title="تعديل"
                                onclick="openModal('operational', '${goal.id}')">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="delete-btn text-red-500 hover:text-red-700 icon-btn ml-2" title="حذف"
                                onclick="deleteOperationalGoal('${goal.id}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    `;

                    list.appendChild(card);
                });
            applyPermissions();
        }

        let opGoalsFilter = { search: '', departmentId: '' };

        function updateOpGoalsDeptFilter() {
            const deptSelect = document.getElementById('opGoalsDeptFilter');
            if (!deptSelect) return;
            deptSelect.innerHTML = `<option value="">كل الإدارات</option>`;
            departments.forEach(d => {
                deptSelect.innerHTML += `<option value="${d.id}">${d.name}</option>`;
            });
        }

        window.filterOperationalGoals = function () {
            opGoalsFilter.search = (document.getElementById('opGoalsSearchInput')?.value || '').trim().toLowerCase();
            opGoalsFilter.departmentId = document.getElementById('opGoalsDeptFilter')?.value || '';
            renderOperationalGoals();
        }

        window.showCalculationMethod = function (goalId, e) {
            e && e.stopPropagation && e.stopPropagation();
            const goal = operationalGoals.find(g => g.id === goalId);
            if (!goal || !goal.calculationMethod || !goal.calculationMethod.trim()) return;
            document.getElementById('modals-root').innerHTML = `
                <div class="modal-bg">
                    <div class="modal-card" style="max-width:520px;">
                        <button class="modal-close-btn" onclick="closeModal()" type="button">
                            <i class="fa fa-times"></i>
                        </button>
                        <h3 class="font-bold text-lg mb-3 text-[#03866d] flex items-center gap-2">
                            <i class="fa fa-info-circle"></i> طريقة حساب المؤشر
                        </h3>
                        <div class="text-gray-800 text-md whitespace-pre-line p-2">${goal.calculationMethod.replace(/</g, "&lt;")}</div>
                    </div>
                </div>
            `;
        };
        
        // FIX: This function is now completely corrected to handle `achievedTypeId` and edge cases like a target of 0.
        function calculateAchievementPercent(period, isReverse = false) {
            let achievedValue = 0;
            const trackingMethod = period.trackingMethod || 'weekly';

            if (trackingMethod === 'direct') {
                achievedValue = period.achieved || 0;
            } else {
                achievedValue = period.weeklyTotalAchieved !== undefined ? period.weeklyTotalAchieved : (period.achieved || 0);
            }

            let percent = 0;
            const typeName = achievementValueTypesMap[period.achievedTypeId] || period.achievedType; // Get name by ID, with fallback

            if (typeName === 'نسبة مئوية') {
                const target = parseFloat(period.target) || 100;
                percent = (parseFloat(achievedValue) / target) * 100;
            } else {
                const target = parseFloat(period.target);
                if (target > 0) {
                    percent = (parseFloat(achievedValue) / target) * 100;
                } else if (target === 0 && parseFloat(achievedValue) >= 0) {
                    percent = 100; // If target is 0, and you achieved 0 or more, you've met/exceeded the goal.
                } else {
                    percent = 0; // Avoid division by zero for negative or invalid targets
                }
            }
            
            percent = isNaN(percent) ? 0 : percent;
            return percent > 500 ? 500 : percent; // Cap percentage for display
        }


        window.deleteOperationalGoal = async function (id) {
            if (!isManager) return;
            if (confirm("هل أنت متأكد من حذف الهدف التشغيلي؟")) {
                db.collection('operationalGoals').doc(id).delete();
            }
        }



        function renderTrackingGoals() {
    let tbody = document.getElementById('trackingTable');
    tbody.innerHTML = "";

    // دالة مساعدة لحساب رقم الأسبوع المطلق في السنة (1-52)
    // تفترض أن كل ربع = 13 أسبوع
    const getAbsoluteWeek = (q, relativeWeek) => {
        const quarterIndex = parseInt(q.replace('Q', '')) - 1; // Q1=0, Q2=1, Q3=2, Q4=3
        return (quarterIndex * 13) + relativeWeek;
    };

    let filteredGoals = operationalGoals.filter(g => {
        // 1. فلتر البحث النصي
        let matchSearch = true;
        if (trackingFilter.search) {
            let searchIn = (g.goal || '') + ' ' + (g.strategicGoalText || '') + ' ' + (g.indicator || '') + ' ' + (departmentsMap[g.departmentId] || '');
            matchSearch = searchIn.toLowerCase().includes(trackingFilter.search);
        }

        // 2. فلتر الإدارة
        let matchDept = !trackingFilter.departmentId || g.departmentId == trackingFilter.departmentId;

        // 3. فلتر الربع
        // نتأكد من أن الهدف يحتوي على بيانات للفترة المحددة
        let matchQuarter = !trackingFilter.quarter || (g.progress && g.progress.some(p => p.quarter === trackingFilter.quarter));

        // 4. فلتر طريقة المتابعة
        let goalMethod = g.trackingMethod || 'weekly';
        let matchMethod = !trackingFilter.method || goalMethod === trackingFilter.method;

        // 5. فلتر الأسبوع (المنطق الجديد)
        let matchWeek = true;
        // نطبق فلتر الأسبوع فقط إذا تم اختياره وكانت طريقة الفلترة "تجميع أسبوعي"
        if (trackingFilter.week && trackingFilter.method === 'weekly') {
            if (goalMethod !== 'weekly') {
                // إذا كان الهدف لا يدعم التتبع الأسبوعي، نستبعده
                matchWeek = false;
            } else {
                const selectedWeek = parseInt(trackingFilter.week);
                // نتحقق مما إذا كان الهدف يحتوي على أي فترة تتضمن هذا الأسبوع
                if (!g.progress) {
                    matchWeek = false;
                } else {
                    matchWeek = g.progress.some(period => {
                        // إذا تم تحديد ربع، نفحص فقط الفترات التي تطابق هذا الربع
                        if (trackingFilter.quarter && period.quarter !== trackingFilter.quarter) return false;
                        
                        if (!period.weeks) return false;

                        return period.weeks.some(w => {
                            if (trackingFilter.quarter) {
                                // مقارنة نسبية (1-13) لأن الربع محدد
                                return w.week === selectedWeek;
                            } else {
                                // مقارنة مطلقة (1-52) لأن الربع غير محدد ("كل الأرباع")
                                return getAbsoluteWeek(period.quarter, w.week) === selectedWeek;
                            }
                        });
                    });
                }
            }
        }

        return matchSearch && matchDept && matchQuarter && matchMethod && matchWeek;
    });

    filteredGoals.forEach((g, idx) => {
        // حساب متوسط نسبة الإنجاز بناءً على الفلاتر النشطة
        let totalPercent = 0, count = 0;
        if (g.progress) {
            g.progress.forEach(period => {
                // إذا تم تحديد ربع، نحسب فقط نسبة هذا الربع
                if (trackingFilter.quarter && period.quarter !== trackingFilter.quarter) return;
                
                let percent = calculateAchievementPercent(period, g.isReverse);
                totalPercent += percent;
                count++;
            });
        }
        
        let avgPercent = count > 0 ? totalPercent / count : 0;
        // في حال تم اختيار ربع ولكن لا توجد بيانات له، تظهر النسبة 0
        if (trackingFilter.quarter && count === 0) avgPercent = 0;

        const statusColor = getStatusColor(avgPercent, g.isReverse);

        tbody.innerHTML += `
            <tr class="goal-row" data-goal-id="${g.id}">
                <td class="p-4">${idx + 1}</td>
                <td class="p-4">${g.strategicGoalText || ''}</td>
                <td class="p-4">${g.goal}</td>
                <td class="p-4">${g.indicator || ''}</td>
                <td class="p-4">${g.departmentId ? departmentsMap[g.departmentId] : ''}</td>
                <td class="p-4"><span class="${statusColor} rounded-full px-3 py-1">${avgPercent.toFixed(1)}%</span></td>
                <td class="p-4">
                    <button class="text-blue-500 hover:text-blue-700 font-medium" onclick="showGoalDetails('${g.id}')">
                        <i class="fas fa-eye"></i> للاستعراض والتعديل
                    </button>
                </td>
            </tr>
        `;
    });

    if (filteredGoals.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-6 text-gray-400">لا توجد بيانات تطابق الفلاتر المحددة</td>
            </tr>
        `;
    }
}




        // START: JAVASCRIPT MODIFICATION (Filter State)
        let trackingFilter = { search: '', departmentId: '', quarter: '', method: '', week: '' };
        // END: JAVASCRIPT MODIFICATION (Filter State)

        function updateTrackingDeptFilter() {
            const deptSelect = document.getElementById('trackingDeptFilter');
            if (!deptSelect) return;
            deptSelect.innerHTML = `<option value="">كل الإدارات</option>`;
            departments.forEach(d => {
                deptSelect.innerHTML += `<option value="${d.id}">${d.name}</option>`;
            });
        }

        updateTrackingDeptFilter();


// BLOCK 3 (Updated): Modified Week Options Logic
window.updateTrackingWeekOptions = function() {
    const quarter = document.getElementById('trackingQuarterFilter').value;
    const method = document.getElementById('trackingMethodFilter').value;
    const weekSelect = document.getElementById('trackingWeekFilter');
    
    // إظهار فلتر الأسابيع فقط إذا تم اختيار "تجميع أسبوعي"
    if (method === 'weekly') {
        weekSelect.classList.remove('hidden');
        weekSelect.innerHTML = '<option value="">كل الأسابيع</option>';
        
        if (quarter) {
            // إذا تم اختيار ربع محدد، نعرض 13 أسبوع فقط
            for (let i = 1; i <= 13; i++) {
                 weekSelect.innerHTML += `<option value="${i}">الأسبوع ${i} (من الربع)</option>`;
            }
        } else {
            // إذا لم يتم اختيار ربع (كل الأرباع)، نعرض جميع أسابيع السنة (مثلاً 52 أسبوع)
            for (let i = 1; i <= 52; i++) {
                 weekSelect.innerHTML += `<option value="${i}">الأسبوع ${i}</option>`;
            }
        }
    } else {
        // إخفاء الفلتر إذا كانت الطريقة ليست "تجميع أسبوعي"
        weekSelect.classList.add('hidden');
        weekSelect.value = ""; 
    }
};
        // START: JAVASCRIPT MODIFICATION (Filter Function)
window.filterTrackingTable = function () {
    trackingFilter.search = (document.getElementById('trackingSearchInput')?.value || '').trim().toLowerCase();
    trackingFilter.departmentId = document.getElementById('trackingDeptFilter')?.value || '';
    trackingFilter.quarter = document.getElementById('trackingQuarterFilter')?.value || '';
    // قراءة الفلاتر الجديدة
    trackingFilter.method = document.getElementById('trackingMethodFilter')?.value || '';
    trackingFilter.week = document.getElementById('trackingWeekFilter')?.value || '';
    
    renderTrackingGoals();
}
        // END: JAVASCRIPT MODIFICATION (Filter Function)
        
        function getWeekOffset(quarterString) {
            switch (quarterString) {
                case 'Q1': return 0;
                case 'Q2': return 13;
                case 'Q3': return 26;
                case 'Q4': return 39;
                default: return 0;
            }
        }

        window.toggleWeeklyView = function(element) {
            const weeklyDetails = element.nextElementSibling;
            const icon = element.querySelector('i.fa-chevron-down');
            
            if (weeklyDetails.style.maxHeight) {
                weeklyDetails.style.maxHeight = null;
                icon.style.transform = 'rotate(0deg)';
            } else {
                weeklyDetails.style.maxHeight = weeklyDetails.scrollHeight + "px";
                icon.style.transform = 'rotate(180deg)';
            }
        };
        
        window.updateQuarterlyTotal = function(input) {
            const saveBtn = document.getElementById('saveAchievementsBtn');
            if (saveBtn) saveBtn.disabled = false;

            const weeklyContainer = input.closest('.weekly-details');
            if (!weeklyContainer) return;
            
            const weeklyInputs = weeklyContainer.querySelectorAll('.weekly-achievement-input');
            let total = 0;
            weeklyInputs.forEach(inp => {
                total += parseFloat(inp.value) || 0;
            });

            const quarterRow = weeklyContainer.previousElementSibling;
            const quarterTotalInput = quarterRow.querySelector('.quarter-total-achieved');
            if (quarterTotalInput) quarterTotalInput.value = total;
        };


        window.showGoalDetails = function (goalId) {
            const goal = operationalGoals.find(g => g.id === goalId);
            if (!goal) return;
        
            const userDepts = userProfile.departmentIds || (userProfile.departmentId ? [userProfile.departmentId] : []);
            const isEditable = isManager || userDepts.includes(goal.departmentId);
            
            const periods = goal.progress || [];
            const avgPercent = periods.length > 0 ?
                periods.reduce((sum, p) => sum + calculateAchievementPercent(p, goal.isReverse), 0) / periods.length : 0;
            const overallStatusColor = getStatusColor(avgPercent, goal.isReverse);
            const reverseText = goal.isReverse ? `<span class="reverse-indicator">↪️</span>` : "";
            
            const trackingMethod = goal.trackingMethod || 'weekly';

            const modalHtml = `
                <div class="modal-bg">
                    <div class="modal-card tracking-modal">
                        <button class="modal-close-btn" onclick="closeModal()">
                            <i class="fa fa-times"></i>
                        </button>
                        <h3 class="font-bold text-xl mb-4 text-[#03866d] flex items-center gap-3"><i class="fa-solid ${goal.icon || 'fa-tasks'}"></i> ${reverseText} ${goal.goal}</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div><p class="text-gray-600 text-sm">الهدف الاستراتيجي:</p><p class="font-medium text-gray-800">${goal.strategicGoalText || 'غير محدد'}</p></div>
                            <div><p class="text-gray-600 text-sm">الإدارة:</p><p class="font-medium text-gray-800">${goal.departmentId ? departmentsMap[goal.departmentId] : 'غير محدد'}</p></div>
                            <div><p class="text-gray-600 text-sm">المؤشر:</p><p class="font-medium text-gray-800">${goal.indicator || 'غير محدد'}</p></div>
                            <div><p class="text-gray-600 text-sm">حالة الإنجاز:</p><p class="font-medium ${overallStatusColor} rounded-full px-3 py-1 inline-block">(${avgPercent.toFixed(1)}%)</p></div>
                        </div>
                        <h4 class="font-bold text-lg mb-3 text-[#03866d] border-b pb-2">تفاصيل الإنجاز لكل فترة:</h4>
                        <div class="tracking-periods custom-scroll">
                            <div class="tracking-period-header">
                                <div>الفترة الزمنية</div>
                                <div>المستهدف</div>
                                <div>المنجز</div>
                                <div>نسبة الإنجاز</div>
                            </div>
                            ${periods.length > 0 ? periods.sort((a,b) => (a.year+a.quarter).localeCompare(b.year+b.quarter)).map(period => {
                                const periodPercent = calculateAchievementPercent(period, goal.isReverse);
                                const periodStatusColor = getStatusColor(periodPercent, goal.isReverse);
                                let achievedValue;
                                if (trackingMethod === 'direct') {
                                    achievedValue = period.achieved || 0;
                                } else {
                                    achievedValue = period.weeklyTotalAchieved !== undefined ? period.weeklyTotalAchieved : (period.achieved || 0);
                                }

                                const typeName = achievementValueTypesMap[period.achievedTypeId] || period.achievedType || '';

                                if (trackingMethod === 'weekly') {
                                    const weeklyData = period.weeks && period.weeks.length > 0 ? period.weeks : Array.from({ length: 13 }, (_, i) => ({ week: i + 1, achieved: 0 }));
                                    const weekOffset = getWeekOffset(period.quarter);
                                    // START MODIFICATION: Add "current value" display
                                    return `
                                        <div class="tracking-period-container border-b last:border-b-0 border-gray-200" data-year="${period.year}" data-quarter="${period.quarter}">
                                            <div class="tracking-period-item cursor-pointer" onclick="toggleWeeklyView(this)">
                                                <div class="font-medium flex items-center justify-between">
                                                    <span>${period.year} - الربع ${period.quarter.replace("Q", "")}</span>
                                                    <i class="fas fa-chevron-down text-xs text-gray-400 ml-2 transition-transform duration-300"></i>
                                                </div>
                                                <div>${period.target}<div class="achievement-type">${typeName}</div></div>
                                                <div>
                                                    <input type="text" class="achievement-input bg-gray-100 cursor-not-allowed quarter-total-achieved" value="${achievedValue}" readonly>
                                                    <div class="achievement-type">من الأسابيع</div>
                                                </div>
                                                <div><span class="${periodStatusColor} rounded-full px-3 py-1">${periodPercent.toFixed(1)}%</span></div>
                                            </div>
                                            <div class="weekly-details">
                                                <div class="bg-gray-50 p-4 border-t border-dashed">
                                                    <h5 class="font-bold text-sm mb-3 text-gray-600">تفاصيل الإنجاز الأسبوعي:</h5>
                                                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-x-4 gap-y-3">
                                                        ${weeklyData.map(week => `
                                                        <div class="flex flex-col">
                                                            <label class="text-xs mb-1 text-gray-500 font-medium">الأسبوع ${week.week + weekOffset}</label>
                                                            <input type="number" class="achievement-input weekly-achievement-input text-sm p-2" value="${week.achieved || 0}" min="0" data-week="${week.week}" ${!isEditable ? 'disabled' : ''} oninput="updateQuarterlyTotal(this)">
                                                            ${isEditable ? `<div class="text-xs text-gray-500 mt-1">القيمة الحالية: ${week.achieved || 0}</div>` : ''}
                                                        </div>`).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>`;
                                    // END MODIFICATION
                                } else { // Direct Entry
                                    // START MODIFICATION: Add "current value" display
                                    return `
                                        <div class="tracking-period-container border-b last:border-b-0 border-gray-200" data-year="${period.year}" data-quarter="${period.quarter}">
                                            <div class="tracking-period-item">
                                                <div class="font-medium">${period.year} - الربع ${period.quarter.replace("Q", "")}</div>
                                                <div>${period.target}<div class="achievement-type">${typeName}</div></div>
                                                <div>
                                                    <input type="number" class="achievement-input direct-achievement-input" value="${achievedValue}" ${!isEditable ? 'disabled' : ''} oninput="document.getElementById('saveAchievementsBtn').disabled=false;">
                                                    ${isEditable ? `<div class="text-xs text-gray-500 mt-1">القيمة الحالية: ${achievedValue}</div>` : ''}
                                                </div>
                                                <div><span class="${periodStatusColor} rounded-full px-3 py-1">${periodPercent.toFixed(1)}%</span></div>
                                            </div>
                                        </div>`;
                                    // END MODIFICATION
                                }
                            }).join('') : `<div class="text-center py-6 text-gray-400 bg-gray-50 rounded-lg">لا توجد فترات زمنية محددة</div>`}
                        </div>
                        ${isEditable ? `<button id="saveAchievementsBtn" class="btn-main w-full mt-6" onclick="saveAchievements('${goal.id}')" disabled><i class="fas fa-save mr-2"></i> حفظ التغييرات</button>` : ''}
                    </div>
                </div>`;
            document.getElementById('modals-root').innerHTML = modalHtml;
        };
        
        window.saveAchievements = async function (goalId) {
            const goal = operationalGoals.find(g => g.id === goalId);
            if (!goal) return;
            const userDepts = userProfile.departmentIds || (userProfile.departmentId ? [userProfile.departmentId] : []);
            const isEditable = isManager || userDepts.includes(goal.departmentId);
            if (!isEditable) return;
        
            showLoading('جاري حفظ التغييرات...');
            const trackingMethod = goal.trackingMethod || 'weekly';
        
            try {
                const updatedProgress = JSON.parse(JSON.stringify(goal.progress)); // Deep copy
                const periodContainers = document.querySelectorAll('.tracking-period-container');
                const changes = [];
        
                periodContainers.forEach(container => {
                    const year = container.getAttribute('data-year');
                    const quarter = container.getAttribute('data-quarter');
                    const progressItem = updatedProgress.find(p => p.year === year && p.quarter === quarter);
                    if (!progressItem) return;
        
                    if (trackingMethod === 'weekly') {
                        const weeklyInputs = container.querySelectorAll('.weekly-achievement-input');
                        const updatedWeeks = [];
                        let weeklyTotal = 0;
        
                        weeklyInputs.forEach(input => {
                            const week = parseInt(input.getAttribute('data-week'));
                            const achieved = parseFloat(input.value) || 0;
                            updatedWeeks.push({ week, achieved });
                            weeklyTotal += achieved;
                        });
                        updatedWeeks.sort((a, b) => a.week - b.week);
                        
                        if ((progressItem.weeklyTotalAchieved || 0) !== weeklyTotal) {
                            changes.push({ userId: userProfile.id, year, quarter, oldValue: progressItem.weeklyTotalAchieved || 0, newValue: weeklyTotal, note: "Weekly total updated", changedAt: new Date() });
                        }
                        
                        progressItem.weeklyTotalAchieved = weeklyTotal; 
                        progressItem.weeks = updatedWeeks;
                    } else { // Direct Entry
                        const directInput = container.querySelector('.direct-achievement-input');
                        const newAchievedValue = parseFloat(directInput.value) || 0;
                        if(progressItem.achieved !== newAchievedValue) {
                           changes.push({ userId: userProfile.id, year, quarter, oldValue: progressItem.achieved || 0, newValue: newAchievedValue, note: "Direct value updated", changedAt: new Date() });
                           progressItem.achieved = newAchievedValue;
                        }
                    }
                });
                
                await db.collection('operationalGoals').doc(goalId).update({
                    progress: updatedProgress,
                    updatedAt: new Date(),
                    history: firebase.firestore.FieldValue.arrayUnion(...changes)
                });
        
                hideLoading();
                showToast('تم حفظ التغييرات بنجاح');
                showGoalDetails(goalId); // Re-open the modal to show updated percentages
                const saveBtn = document.getElementById('saveAchievementsBtn');
                if(saveBtn) saveBtn.disabled = true;
        
            } catch (error) {
                hideLoading();
                showToast('حدث خطأ أثناء حفظ التغييرات', 'error');
                console.error('Error saving achievements:', error);
            }
        };


        function refreshUsers() {
            db.collection('users').orderBy('name').onSnapshot(snap => {
                users = [];
                snap.forEach(d => users.push({ id: d.id, ...d.data() }));
                renderUsers();
            });
        }

        function renderUsers() {
            const list = document.getElementById('usersList');
            if (!list) return;
            list.innerHTML = "";

            if (!users.length) {
                list.innerHTML = `<tr><td colspan="5" class="text-center text-gray-500 p-6">لا يوجد مستخدمون</td></tr>`;
                return;
            }

            users.forEach(u => {
                let userDeptIds = u.departmentIds;
                if (!Array.isArray(userDeptIds) && u.departmentId) {
                    userDeptIds = [u.departmentId];
                }
                const deptNames = (userDeptIds || [])
                    .map(id => departmentsMap[id])
                    .filter(Boolean) 
                    .join('، ') || 'غير محدد';

                list.innerHTML += `
                    <tr>
                        <td class="table-td p-4 font-bold">${u.name || ""}</td>
                        <td class="table-td p-4">${deptNames}</td>
                        <td class="table-td p-4">${u.email || ''}</td>
                        <td class="table-td p-4">${u.role === 'manager' ? 'مدير' : 'مستخدم'}</td>
                        <td class="table-td p-4">
                            <button class="edit-user-btn text-blue-500 hover:text-blue-700 icon-btn" title="تعديل" 
                                onclick="openModal('user-edit','${u.id}')">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="delete-user-btn text-red-500 hover:text-red-700 icon-btn ml-2" title="حذف"
                                onclick="deleteUser('${u.id}', '${u.email || ''}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            applyPermissions();
        }

        window.deleteUser = async function(id, email) {
            if (!isManager) {
                showToast('ليس لديك صلاحية لحذف المستخدمين', 'error');
                return;
            }
            if (email === userProfile.email) {
                showToast('لا يمكنك حذف حسابك الخاص', 'error');
                return;
            }

            if (confirm(`هل أنت متأكد من حذف المستخدم: ${email}؟ هذا الإجراء لا يمكن التراجع عنه.`)) {
                showLoading('جاري حذف المستخدم...');
                try {
                    await db.collection('users').doc(id).delete();
                    hideLoading();
                    showToast('تم حذف المستخدم بنجاح');
                } catch (error) {
                    hideLoading();
                    showToast('حدث خطأ أثناء الحذف', 'error');
                    console.error('Error deleting user:', error);
                }
            }
        }
        
        function refreshAchievementValueTypes() {
            db.collection('achievementValueTypes').orderBy('name').onSnapshot(snap => {
                achievementValueTypes = [];
                achievementValueTypesMap = {}; // Reset map
                snap.forEach(d => {
                    const typeData = { id: d.id, ...d.data() };
                    achievementValueTypes.push(typeData);
                    achievementValueTypesMap[d.id] = typeData.name; // Populate map
                });
                renderAchievementValueTypes();
            });
        }

        function renderAchievementValueTypes() {
            let list = document.getElementById('achievementValueTypesList');
            if (!list) return;
            list.innerHTML = "";
            if (!achievementValueTypes.length) {
                list.innerHTML = `<tr><td colspan="2" class="text-center text-gray-500 p-6">لا توجد أنواع قيم</td></tr>`;
                if(isManager) {
                    if(!achievementValueTypes.find(t => t.name === 'نسبة مئوية')) db.collection('achievementValueTypes').add({ name: 'نسبة مئوية', createdAt: new Date() });
                    if(!achievementValueTypes.find(t => t.name === 'قيمة رقمية')) db.collection('achievementValueTypes').add({ name: 'قيمة رقمية', createdAt: new Date() });
                }
                return;
            }
            achievementValueTypes.forEach(type => {
                list.innerHTML += `
                    <tr>
                        <td class="table-td p-4 font-bold">${type.name}</td>
                        <td class="table-td p-4">
                            <button class="edit-achievement-value-type-btn text-blue-500 hover:text-blue-700 icon-btn" title="تعديل" 
                                    onclick="openModal('achievementValueType-edit','${type.id}')">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="delete-achievement-value-type-btn text-red-500 hover:text-red-700 icon-btn ml-2" title="حذف" 
                                    onclick="deleteAchievementValueType('${type.id}')">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            applyPermissions();
        }
        
        // FIX: Added check to prevent deleting a type that is currently in use.
        window.deleteAchievementValueType = async function (id) {
            if (!isManager) return;

            const goalsInUse = operationalGoals.some(goal => 
                goal.progress && goal.progress.some(p => p.achievedTypeId === id || (p.achievedType && !p.achievedTypeId && achievementValueTypesMap[id] === p.achievedType))
            );

            if (goalsInUse) {
                showToast("لا يمكن حذف هذا النوع لأنه مستخدم في هدف تشغيلي واحد على الأقل.", "error");
                return;
            }

            if (confirm("هل أنت متأكد من حذف نوع القيمة؟")) {
                db.collection('achievementValueTypes').doc(id).delete().then(() => {
                    showToast("تم حذف نوع القيمة بنجاح");
                }).catch(err => {
                    showToast("حدث خطأ أثناء الحذف", "error");
                });
            }
        }

        window.closeModal = function () {
            document.getElementById('modals-root').innerHTML = "";
        };

        window.showLoading = function (msg = "جاري التحميل...") {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            document.getElementById('loadingText').textContent = msg;
        };
        
        window.hideLoading = function () {
            document.getElementById('loadingOverlay').classList.add('hidden');
        };

        window.openModal = function (type, id = null) {
            let root = document.getElementById('modals-root');
            root.innerHTML = "";
            let modal = document.createElement('div');
            modal.className = "modal-bg";
            let yearNow = new Date().getFullYear();

            if (type === "strategic") {
                let goalVal = "", editId = "";
                let yearsVal = [];
                if (id) {
                    let g = strategicGoals.find(x => x.id == id);
                    if (g) {
                        goalVal = g.goal;
                        yearsVal = Array.isArray(g.years) ? g.years : (g.year ? [g.year] : []);
                        editId = g.id;
                    }
                }
                let yearsOptHtml = '';
                for (let i = 0; i < 6; i++) {
                    let y = yearNow + i;
                    yearsOptHtml += `<option value="${y}" ${yearsVal.includes(String(y)) ? 'selected' : ''}>${y}</option>`;
                }
                modal.innerHTML = `
                    <form id="strategicFormModal" class="modal-card">
                        <button class="modal-close-btn" onclick="closeModal()" type="button"><i class="fa fa-times"></i></button>
                        <h3 class="font-bold text-xl mb-4 text-[#03866d]">${id ? 'تعديل' : 'إضافة'} هدف استراتيجي</h3>
                        <input type="hidden" name="id" value="${editId || ''}">
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-600">السنوات</label>
                            <select class="input w-full" name="years" id="strategicYearsSelect" multiple>${yearsOptHtml}</select>
                        </div>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-600">نص الهدف</label>
                            <textarea class="input w-full" name="goal" rows="3" required>${goalVal || ''}</textarea>
                        </div>
                        <button class="btn-main w-full mt-2">${id ? 'تعديل' : 'إضافة'}</button>
                    </form>
                `;
                root.appendChild(modal);

                setTimeout(() => {
                    new Choices(document.getElementById('strategicYearsSelect'), {
                        removeItemButton: true, placeholder: true, placeholderValue: "اختر السنوات ...",
                        itemSelectText: "", noResultsText: "لا توجد نتائج"
                    });
                }, 100);

                document.getElementById('strategicFormModal').onsubmit = function (e) {
                    e.preventDefault();
                    let fd = new FormData(e.target);
                    let id = fd.get('id');
                    let goal = fd.get('goal');
                    let years = Array.from(document.getElementById('strategicYearsSelect').selectedOptions).map(o => o.value);

                    if (!years.length) {
                        showToast('يجب اختيار سنة واحدة على الأقل', 'error');
                        return;
                    }

                    showLoading('جاري الحفظ...');
                    let col = db.collection('strategicGoals');
                    let dataObj = { goal, years, updatedAt: new Date() };

                    let action = id ? col.doc(id).update(dataObj) : col.add({ ...dataObj, createdAt: new Date() });

                    action.then(() => {
                        hideLoading(); closeModal(); showToast('تم الحفظ بنجاح');
                    }).catch(() => {
                        hideLoading(); showToast('حدث خطأ أثناء الحفظ', 'error');
                    });
                };
            }

            if (type === "operational") {
                let data = {
                    goal: '', strategicGoalId: '', departmentId: '', progress: [], id: "",
                    indicator: "", weight: "", isReverse: false, excludeFromCalculation: false,
                    calculationMethod: '',
                    trackingMethod: 'weekly',
                    displayOptions: ['general', 'operational'],
                    icon: 'fa-tasks'
                };

                if (id) {
                    let g = operationalGoals.find(x => x.id == id);
                    if (g) data = { ...data, ...g };
                }

                let strategicOpts = `<option value="">اختر الهدف الاستراتيجي</option>`;
                strategicGoals.forEach(g => {
                    strategicOpts += `<option value="${g.id}" ${data.strategicGoalId == g.id ? 'selected' : ''}>
                        ${g.goal} (${Array.isArray(g.years) ? g.years.join(', ') : g.year})</option>`;
                });

                let deptOpts = `<option value="">اختر الإدارة</option>`;
                departments.forEach(d => {
                    deptOpts += `<option value="${d.id}" ${data.departmentId == d.id ? 'selected' : ''}>${d.name}</option>`;
                });
                
                // FIX: Options now use ID for value
                let valueTypeOptions = achievementValueTypes.map(vt => `<option value="${vt.id}">${vt.name}</option>`).join('');

                let periodsHtml = '';
                if (data.progress && data.progress.length > 0) {
                    data.progress.forEach(period => {
                        // FIX: Select correct option based on ID
                        let dynamicValueTypeOptions = achievementValueTypes.map(vt => 
                            `<option value="${vt.id}" ${(period.achievedTypeId === vt.id || (period.achievedType === vt.name && !period.achievedTypeId)) ? 'selected' : ''}>${vt.name}</option>`
                        ).join('');
                        
                        // START MODIFICATION: Make 'achieved' field readonly and calculate its value
                        const achievedDisplayValue = (data.trackingMethod === 'weekly')
                            ? (period.weeklyTotalAchieved !== undefined ? period.weeklyTotalAchieved : (period.achieved || 0))
                            : (period.achieved || 0);

                        periodsHtml += `
                            <div class="period-card" data-year="${period.year}" data-quarter="${period.quarter}">
                                <div class="period-header">
                                    <span>${period.year} - الربع ${period.quarter.replace("Q", "")}</span>
                                    <button type="button" class="period-remove-btn" onclick="removePeriod(this)"><i class="fas fa-times"></i></button>
                                </div>
                                <div class="target-inputs">
                                    <div>
                                        <label class="block mb-1 text-sm text-gray-600">المستهدف</label>
                                        <input type="text" class="input w-full period-target" value="${period.target}" required>
                                    </div>
                                    <div>
                                        <label class="block mb-1 text-sm text-gray-600">المنجز</label>
                                        <input type="text" class="input w-full period-achieved bg-gray-100" value="${achievedDisplayValue}" readonly>
                                    </div>
                                </div>
                                <div>
                                    <label class="block mb-1 text-sm text-gray-600">نوع القيمة</label>
                                    <select class="input w-full period-type" required>
                                        ${dynamicValueTypeOptions}
                                    </select>
                                </div>
                            </div>
                        `;
                        // END MODIFICATION
                    });
                } else {
                    periodsHtml = `<div class="no-periods">لم يتم إضافة أي فترات زمنية بعد</div>`;
                }

                modal.innerHTML = `
                    <form id="operationalFormModal" class="modal-card" style="max-width: 800px;">
                        <button class="modal-close-btn" onclick="closeModal()" type="button"><i class="fa fa-times"></i></button>
                        <h3 class="font-bold text-xl mb-6 text-[#03866d]">${id ? 'تعديل' : 'إضافة'} هدف تشغيلي</h3>
                        <input type="hidden" name="id" value="${data.id || ''}">
                        
                        <div class="space-y-6">
                            <div class="border-b pb-6">
                                <h4 class="font-bold text-md mb-3 text-gray-700">1. المعلومات الأساسية</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block mb-2 text-sm font-bold text-gray-600">الهدف الاستراتيجي</label>
                                        <select class="input w-full" name="strategicGoalId" id="strategicGoalIdSelect" required>${strategicOpts}</select>
                                    </div>
                                    <div>
                                        <label class="block mb-2 text-sm font-bold text-gray-600">الإدارة</label>
                                        <select class="input w-full" name="departmentId" required>${deptOpts}</select>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="block mb-2 text-sm font-bold text-gray-600">نص الهدف</label>
                                    <div class="flex items-start gap-3">
                                        <div class="flex-1">
                                            <textarea class="input w-full" name="goal" rows="3" required>${data.goal || ''}</textarea>
                                        </div>
                                        <div>
                                            <input type="hidden" id="goalIconInput" name="icon" value="${data.icon || 'fa-tasks'}">
                                            <button type="button" id="iconSelectBtn" onclick="window.openIconPicker()" class="w-24 h-full flex flex-col items-center justify-center border border-gray-300 rounded-lg hover:border-primary-color transition">
                                                <i class="fa-solid ${data.icon || 'fa-tasks'} text-2xl text-slate-500"></i>
                                                <span class="text-xs mt-1">اختر أيقونة</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="border-b pb-6">
                                <h4 class="font-bold text-md mb-3 text-gray-700">2. المؤشر والقياس</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block mb-2 text-sm font-bold text-gray-600">المؤشر</label>
                                        <input class="input w-full" name="indicator" value="${data.indicator || ''}" required>
                                    </div>
                                    <div>
                                        <label class="block mb-2 text-sm font-bold text-gray-600">طريقة المتابعة</label>
                                        <select class="input w-full" name="trackingMethod">
                                            <option value="weekly" ${data.trackingMethod === 'weekly' ? 'selected' : ''}>تجميع أسبوعي</option>
                                            <option value="direct" ${data.trackingMethod === 'direct' ? 'selected' : ''}>إدخال مباشر للفترة</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block mb-2 text-sm font-bold text-gray-600">الوزن</label>
                                        <input class="input w-full" name="weight" id="goalWeightInput" type="text" value="${data.weight || ''}" 
                                            ${data.excludeFromCalculation ? 'disabled' : ''} ${data.excludeFromCalculation ? '' : 'required'}>
                                    </div>
                                    <div>
                                        <label class="block mb-2 text-sm font-bold text-gray-600">طريقة حساب المؤشر (اختياري)</label>
                                        <input class="input w-full" name="calculationMethod" value="${data.calculationMethod || ''}">
                                    </div>
                                </div>
                                <div class="flex items-center gap-6">
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" name="excludeFromCalculation" id="excludeFromCalculationCheckbox"
                                            ${data.excludeFromCalculation ? "checked" : ""} onchange="toggleWeightInput()">
                                        <label for="excludeFromCalculationCheckbox" class="text-sm font-bold text-gray-600">بدون وزن</label>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <input type="checkbox" name="isReverse" id="isReverseCheckbox" ${data.isReverse ? "checked" : ""}>
                                        <label for="isReverseCheckbox" class="text-sm font-bold text-gray-600">هدف عكسي (الأقل أفضل)</label>
                                    </div>
                                </div>
                            </div>

                             <div class="border-b pb-6">
                                <h4 class="font-bold text-md mb-3 text-gray-700">3. خيارات العرض</h4>
                                <div class="flex items-center gap-6">
                                   <div class="flex items-center gap-2">
                                        <input type="checkbox" name="displayOnGeneral" id="displayOnGeneral" ${data.displayOptions?.includes('general') ? 'checked' : ''}>
                                        <label for="displayOnGeneral" class="text-sm font-bold text-gray-600 flex items-center gap-1.5"><i class="fas fa-gauge-high"></i> الشاشة العامة</label>
                                   </div>
                                   <div class="flex items-center gap-2">
                                        <input type="checkbox" name="displayOnOperational" id="displayOnOperational" ${data.displayOptions?.includes('operational') ? 'checked' : ''}>
                                        <label for="displayOnOperational" class="text-sm font-bold text-gray-600 flex items-center gap-1.5"><i class="fas fa-list-check"></i> الأداء التشغيلي</label>
                                   </div>
                                </div>
                            </div>

                            <div>
                                <h4 class="font-bold text-md mb-3 text-gray-700">4. الفترات الزمنية</h4>
                                <div class="period-selector-container">
                                    <div class="period-selector">
                                        <select id="yearSelect" class="input period-year-select"><option value="">اختر السنة</option></select>
                                        <select id="quarterSelect" class="input period-quarter-select" multiple>
                                            <option value="Q1">الربع الأول</option> <option value="Q2">الربع الثاني</option>
                                            <option value="Q3">الربع الثالث</option> <option value="Q4">الربع الرابع</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn-main mb-4 mt-2" onclick="addPeriod()"><i class="fas fa-plus mr-2"></i>إضافة فترة</button>
                                </div>
                                <div id="selectedPeriods" class="mb-4">${periodsHtml}</div>
                            </div>
                        </div>

                        <button class="btn-main w-full mt-6">${id ? 'تحديث الهدف' : 'إضافة الهدف'}</button>
                    </form>
                `;

                root.appendChild(modal);

                setTimeout(() => {
                    new Choices(document.getElementById('quarterSelect'), {
                        removeItemButton: true, placeholder: true, placeholderValue: "اختر الأرباع ...",
                        itemSelectText: "", noResultsText: "لا توجد نتائج"
                    });

                    const strategicGoalSelect = document.getElementById('strategicGoalIdSelect');
                    const yearSelect = document.getElementById('yearSelect');

                    function updateYearOptions() {
                        const selectedGoalId = strategicGoalSelect.value;
                        const selectedGoal = strategicGoals.find(g => g.id === selectedGoalId);
                        yearSelect.innerHTML = '<option value="">اختر السنة</option>';
                        if (selectedGoal && selectedGoal.years) {
                            selectedGoal.years.forEach(year => {
                                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
                            });
                        }
                    }

                    strategicGoalSelect.addEventListener('change', updateYearOptions);
                    if (data.strategicGoalId) {
                        updateYearOptions();
                    }
                }, 100);

                window.toggleWeightInput = function () {
                    const checkbox = document.getElementById('excludeFromCalculationCheckbox');
                    const weightInput = document.getElementById('goalWeightInput');
                    weightInput.disabled = checkbox.checked;
                    weightInput.required = !checkbox.checked;
                    if (checkbox.checked) weightInput.value = "";
                };

                window.addPeriod = function () {
                    const yearSelect = document.getElementById('yearSelect');
                    const quarterSelect = document.getElementById('quarterSelect');
                    const container = document.getElementById('selectedPeriods');

                    if (!yearSelect.value) {
                        showToast('يجب اختيار سنة أولاً', 'error'); return;
                    }

                    const selectedQuarters = Array.from(quarterSelect.selectedOptions).map(o => o.value);
                    if (selectedQuarters.length === 0) {
                        showToast('يجب اختيار ربع واحد على الأقل', 'error'); return;
                    }

                    if (container.querySelector('.no-periods')) container.innerHTML = '';
                    
                    let valueTypeOptions = achievementValueTypes.map(vt => `<option value="${vt.id}">${vt.name}</option>`).join('');

                    selectedQuarters.forEach(quarter => {
                        if (container.querySelector(`[data-year="${yearSelect.value}"][data-quarter="${quarter}"]`)) return;

                        const periodCard = document.createElement('div');
                        periodCard.className = 'period-card';
                        periodCard.setAttribute('data-year', yearSelect.value);
                        periodCard.setAttribute('data-quarter', quarter);
                        // START MODIFICATION: Make 'achieved' field readonly on creation
                        periodCard.innerHTML = `
                            <div class="period-header">
                                <span>${yearSelect.value} - الربع ${quarter.replace("Q", "")}</span>
                                <button type="button" class="period-remove-btn" onclick="removePeriod(this)"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="target-inputs">
                                <div><label class="block mb-1 text-sm text-gray-600">المستهدف</label><input type="number" class="input w-full period-target" value="" required></div>
                                <div><label class="block mb-1 text-sm text-gray-600">المنجز</label><input type="number" class="input w-full period-achieved bg-gray-100" value="0" readonly></div>
                            </div>
                            <div>
                                <label class="block mb-1 text-sm text-gray-600">نوع القيمة</label>
                                <select class="input w-full period-type" required>${valueTypeOptions}</select>
                            </div>`;
                        // END MODIFICATION
                        container.appendChild(periodCard);
                    });
                };

                window.removePeriod = function (button) {
                    const card = button.closest('.period-card');
                    card.remove();
                    const container = document.getElementById('selectedPeriods');
                    if (container.children.length === 0) {
                        container.innerHTML = `<div class="no-periods">لم يتم إضافة أي فترات زمنية بعد</div>`;
                    }
                };

                document.getElementById('operationalFormModal').onsubmit = function (e) {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const id = fd.get('id');
                    
                    const displayOptions = [];
                    if (fd.get('displayOnGeneral') === 'on') displayOptions.push('general');
                    if (fd.get('displayOnOperational') === 'on') displayOptions.push('operational');

                    const data = {
                        goal: fd.get('goal'), strategicGoalId: fd.get('strategicGoalId'),
                        departmentId: fd.get('departmentId'), indicator: fd.get('indicator').trim(),
                        trackingMethod: fd.get('trackingMethod'),
                        icon: fd.get('icon'),
                        isReverse: fd.get('isReverse') === 'on', excludeFromCalculation: fd.get('excludeFromCalculation') === 'on',
                        weight: fd.get('excludeFromCalculation') === 'on' ? 0 : parseFloat(fd.get('weight')),
                        calculationMethod: fd.get('calculationMethod') || "",
                        displayOptions: displayOptions,
                    };

                    if (!data.strategicGoalId || !data.departmentId || !data.indicator || (!data.excludeFromCalculation && isNaN(data.weight))) {
                        showToast('جميع الحقول الأساسية مطلوبة', 'error'); return;
                    }

                    data.progress = [];
                    const periodCards = document.querySelectorAll('.period-card');
                    if (periodCards.length === 0) {
                        showToast('يجب إضافة فترة زمنية واحدة على الأقل', 'error'); return;
                    }

                    for (const card of periodCards) {
                        const periodData = {
                            year: card.getAttribute('data-year'), quarter: card.getAttribute('data-quarter'),
                            target: parseFloat(card.querySelector('.period-target').value),
                            // The 'achieved' value is now read-only, so we take the existing value or default to 0
                            achieved: parseFloat(card.querySelector('.period-achieved').value) || 0,
                            achievedTypeId: card.querySelector('.period-type').value, // FIX: Save the ID now
                            trackingMethod: data.trackingMethod 
                        };
                        if (isNaN(periodData.target) || isNaN(periodData.achieved) || !periodData.achievedTypeId) {
                            showToast('يجب إدخال قيم صحيحة واختيار نوع القيمة لجميع الفترات', 'error'); return;
                        }

                        const existingGoal = id ? operationalGoals.find(g => g.id === id) : null;
                        const existingPeriod = existingGoal ? existingGoal.progress.find(p => p.year === periodData.year && p.quarter === periodData.quarter) : null;
                        
                        // Preserve weekly data if it exists
                        periodData.weeks = (existingPeriod?.weeks?.length > 0) ? existingPeriod.weeks : Array.from({ length: 13 }, (_, i) => ({ week: i + 1, achieved: 0 }));
                        periodData.weeklyTotalAchieved = (existingPeriod && existingPeriod.weeklyTotalAchieved !== undefined) ? existingPeriod.weeklyTotalAchieved : 0;
                        
                        // If it's a direct entry, the 'achieved' value is the one we keep.
                        if (data.trackingMethod === 'direct') {
                            periodData.achieved = (existingPeriod && existingPeriod.achieved !== undefined) ? existingPeriod.achieved : 0;
                        }


                        data.progress.push(periodData);
                    }

                    data.strategicGoalText = strategicGoals.find(g => g.id == data.strategicGoalId)?.goal || "";
                    data.updatedAt = new Date();

                    showLoading('جاري الحفظ...');
                    const col = db.collection('operationalGoals');
                    const action = id ? col.doc(id).update(data) : col.add({ ...data, createdAt: new Date() });

                    action.then(() => {
                        hideLoading(); closeModal(); showToast('تم الحفظ بنجاح');
                    }).catch((error) => {
                        hideLoading(); showToast('حدث خطأ أثناء الحفظ', 'error'); console.error('Error:', error);
                    });
                };
            }

            if (type === "department") {
                modal.innerHTML = `
                    <form id="departmentFormModal" class="modal-card">
                        <button class="modal-close-btn" onclick="closeModal()" type="button"><i class="fa fa-times"></i></button>
                        <h3 class="font-bold text-xl mb-4 text-[#03866d]">إضافة إدارة جديدة</h3>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-600">اسم الإدارة</label>
                            <input class="input w-full" name="name" maxlength="40" required>
                        </div>
                        <button class="btn-main w-full mt-2">إضافة</button>
                    </form>
                `;
                root.appendChild(modal);
                document.getElementById('departmentFormModal').onsubmit = async function (e) {
                    e.preventDefault();
                    const name = new FormData(e.target).get('name').trim();
                    if (!name) { showToast('يجب إدخال اسم الإدارة', 'error'); return; }
                    showLoading('جاري إضافة الإدارة...');
                    try {
                        if (departments.some(d => d.name === name)) {
                            hideLoading(); showToast('اسم الإدارة موجود مسبقاً', 'error'); return;
                        }
                        await db.collection('departments').add({ name, createdAt: new Date() });
                        hideLoading(); closeModal(); showToast('تمت إضافة الإدارة بنجاح');
                    } catch (error) {
                        hideLoading(); showToast('حدث خطأ أثناء الإضافة', 'error'); console.error('Error:', error);
                    }
                };
            }

            if (type === "department-edit") {
                const dept = departments.find(d => d.id == id) || {};
                modal.innerHTML = `
                    <form id="departmentEditFormModal" class="modal-card">
                        <button class="modal-close-btn" onclick="closeModal()" type="button"><i class="fa fa-times"></i></button>
                        <h3 class="font-bold text-xl mb-4 text-[#03866d]">تعديل الإدارة</h3>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-600">اسم الإدارة</label>
                            <input class="input w-full" name="name" maxlength="40" value="${dept.name || ''}" required>
                        </div>
                        <button class="btn-main w-full mt-2">تحديث</button>
                    </form>
                `;
                root.appendChild(modal);
                document.getElementById('departmentEditFormModal').onsubmit = async function (e) {
                    e.preventDefault();
                    const name = new FormData(e.target).get('name').trim();
                    if (!name) { showToast('يجب إدخال اسم الإدارة', 'error'); return; }
                    showLoading('جاري تحديث الإدارة...');
                    try {
                        if (departments.some(d => d.name === name && d.id !== id)) {
                            hideLoading(); showToast('اسم الإدارة موجود مسبقاً', 'error'); return;
                        }
                        await db.collection('departments').doc(id).update({ name, updatedAt: new Date() });
                        hideLoading(); closeModal(); showToast('تم تحديث الإدارة بنجاح');
                    } catch (error) {
                        hideLoading(); showToast('حدث خطأ أثناء التحديث', 'error'); console.error('Error:', error);
                    }
                };
            }

            if (type === "user" && isManager) {
                let deptOpts = departments.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                modal.innerHTML = `
                    <form id="userFormModal" class="modal-card">
                        <button class="modal-close-btn" onclick="closeModal()" type="button"><i class="fa fa-times"></i></button>
                        <h3 class="font-bold text-xl mb-4 text-[#03866d]">إضافة مستخدم جديد</h3>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">الاسم</label><input class="input w-full" name="name" required></div>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">البريد الإلكتروني</label><input class="input w-full" name="email" type="email" required></div>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">كلمة المرور</label><input class="input w-full" name="password" type="password" required></div>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">الإدارات</label><select id="userDepartmentsSelect" class="input w-full" multiple>${deptOpts}</select></div>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">الصلاحية</label><select class="input w-full" name="role" required><option value="manager">مدير</option><option value="user" selected>مستخدم</option></select></div>
                        <button class="btn-main w-full mt-2">إضافة</button>
                    </form>
                `;
                root.appendChild(modal);
                setTimeout(() => { new Choices(document.getElementById('userDepartmentsSelect'), { removeItemButton: true, placeholder: true, placeholderValue: "اختر الأقسام...", itemSelectText: "", noResultsText: "لا توجد نتائج"}); }, 100);

                document.getElementById('userFormModal').onsubmit = async function (e) {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const name = fd.get('name').trim(), email = fd.get('email').trim().toLowerCase(), password = fd.get('password'), role = fd.get('role');
                    const departmentIds = Array.from(document.getElementById('userDepartmentsSelect').selectedOptions).map(o => o.value);
                    if (!name || !email || !password || departmentIds.length === 0 || !role) { showToast('جميع الحقول مطلوبة', 'error'); return; }
                    showLoading('جاري إضافة المستخدم...');
                    try {
                        const snapshot = await db.collection('users').where('email', '==', email).limit(1).get();
                        if (!snapshot.empty) { hideLoading(); showToast('البريد الإلكتروني موجود مسبقاً', 'error'); return; }
                        await db.collection('users').add({ name, email, password, departmentIds, role, createdAt: new Date() });
                        hideLoading(); closeModal(); showToast('تمت إضافة المستخدم بنجاح');
                    } catch (error) { hideLoading(); showToast('حدث خطأ أثناء الإضافة', 'error'); console.error('Error:', error); }
                };
            }

            if (type === "user-edit" && isManager) {
                const user = users.find(u => u.id == id) || {};
                let deptOpts = '';
                departments.forEach(d => {
                    const userDepts = user.departmentIds || (user.departmentId ? [user.departmentId] : []);
                    deptOpts += `<option value="${d.id}" ${userDepts.includes(d.id) ? 'selected' : ''}>${d.name}</option>`;
                });
                modal.innerHTML = `
                    <form id="userEditFormModal" class="modal-card">
                        <button class="modal-close-btn" onclick="closeModal()" type="button"><i class="fa fa-times"></i></button>
                        <h3 class="font-bold text-xl mb-4 text-[#03866d]">تعديل مستخدم</h3>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">الاسم</label><input class="input w-full" name="name" value="${user.name || ''}" required></div>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">البريد الإلكتروني</label><input class="input w-full" name="email" type="email" value="${user.email || ''}" required disabled></div>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">كلمة المرور الجديدة (اختياري)</label><input class="input w-full" name="password" type="password" placeholder="اتركه فارغاً للتجاهل"></div>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">الإدارات</label><select id="userEditDepartmentsSelect" class="input w-full" multiple>${deptOpts}</select></div>
                        <div class="mb-4"><label class="block mb-2 text-sm font-bold text-gray-600">الصلاحية</label><select class="input w-full" name="role" required><option value="manager" ${user.role === 'manager' ? 'selected' : ''}>مدير</option><option value="user" ${user.role === 'user' ? 'selected' : ''}>مستخدم</option></select></div>
                        <button class="btn-main w-full mt-2">تحديث</button>
                    </form>
                `;
                root.appendChild(modal);
                setTimeout(() => { new Choices(document.getElementById('userEditDepartmentsSelect'), { removeItemButton: true, placeholder: true, placeholderValue: "اختر الأقسام...", itemSelectText: "", noResultsText: "لا توجد نتائج"}); }, 100);

                document.getElementById('userEditFormModal').onsubmit = async function (e) {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const name = fd.get('name').trim(), password = fd.get('password'), role = fd.get('role');
                    const departmentIds = Array.from(document.getElementById('userEditDepartmentsSelect').selectedOptions).map(o => o.value);
                    if (!name || departmentIds.length === 0 || !role) { showToast('جميع الحقول مطلوبة', 'error'); return; }
                    showLoading('جاري تحديث المستخدم...');
                    try {
                        const updateData = { name, departmentIds, role, updatedAt: new Date() };
                        if (password) { updateData.password = password; }
                        await db.collection('users').doc(id).update(updateData);
                        hideLoading(); closeModal(); showToast('تم تحديث المستخدم بنجاح');
                    } catch (error) { hideLoading(); showToast('حدث خطأ أثناء التحديث', 'error'); console.error('Error:', error); }
                };
            }

            if (type === "achievementValueType" && isManager) {
                modal.innerHTML = `
                    <form id="achievementValueTypeFormModal" class="modal-card">
                        <button class="modal-close-btn" onclick="closeModal()" type="button"><i class="fa fa-times"></i></button>
                        <h3 class="font-bold text-xl mb-4 text-[#03866d]">إضافة نوع قيمة جديد</h3>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-600">اسم النوع (مثال: نسبة مئوية، قيمة رقمية)</label>
                            <input class="input w-full" name="name" maxlength="50" required>
                        </div>
                        <button class="btn-main w-full mt-2">إضافة</button>
                    </form>
                `;
                root.appendChild(modal);
                document.getElementById('achievementValueTypeFormModal').onsubmit = async function (e) {
                    e.preventDefault();
                    const name = new FormData(e.target).get('name').trim();
                    if (!name) { showToast('يجب إدخال اسم النوع', 'error'); return; }
                    showLoading('جاري إضافة النوع...');
                    try {
                        if (achievementValueTypes.some(t => t.name === name)) {
                            hideLoading(); showToast('اسم النوع موجود مسبقاً', 'error'); return;
                        }
                        await db.collection('achievementValueTypes').add({ name, createdAt: new Date() });
                        hideLoading(); closeModal(); showToast('تمت إضافة النوع بنجاح');
                    } catch (error) {
                        hideLoading(); showToast('حدث خطأ أثناء الإضافة', 'error');
                    }
                };
            }

            if (type === "achievementValueType-edit" && isManager) {
                const achType = achievementValueTypes.find(t => t.id == id) || {};
                modal.innerHTML = `
                    <form id="achievementValueTypeEditFormModal" class="modal-card">
                        <button class="modal-close-btn" onclick="closeModal()" type="button"><i class="fa fa-times"></i></button>
                        <h3 class="font-bold text-xl mb-4 text-[#03866d]">تعديل نوع القيمة</h3>
                        <div class="mb-4">
                            <label class="block mb-2 text-sm font-bold text-gray-600">اسم النوع</label>
                            <input class="input w-full" name="name" maxlength="50" value="${achType.name || ''}" required>
                        </div>
                        <button class="btn-main w-full mt-2">تحديث</button>
                    </form>
                `;
                root.appendChild(modal);
                document.getElementById('achievementValueTypeEditFormModal').onsubmit = async function (e) {
                    e.preventDefault();
                    const name = new FormData(e.target).get('name').trim();
                    if (!name) { showToast('يجب إدخال اسم النوع', 'error'); return; }
                    showLoading('جاري تحديث النوع...');
                    try {
                        if (achievementValueTypes.some(t => t.name === name && t.id !== id)) {
                            hideLoading(); showToast('اسم النوع موجود مسبقاً', 'error'); return;
                        }
                        await db.collection('achievementValueTypes').doc(id).update({ name, updatedAt: new Date() });
                        hideLoading(); closeModal(); showToast('تم تحديث النوع بنجاح');
                    } catch (error) {
                        hideLoading(); showToast('حدث خطأ أثناء التحديث', 'error');
                    }
                };
            }

            modal.onclick = function (e) {
                if (e.target === modal) {
                    closeModal();
                }
            };
        }
    }
    </script>

</body>

</html>